# Docker Compose for OWASP ZAP Scanner and WebCheck
# Frontend and Backend run natively with Node.js (npm run dev / npm start)

version: '3.8'

services:
  # OWASP ZAP Scanner - Production Configuration (v4.0)
  # Handles 15K+ URLs, prevents video file loops, eliminates crashes
  zap:
    image: ghcr.io/zaproxy/zaproxy:stable
    container_name: zap-scanner
    restart: unless-stopped
    ports:
      - "8080:8080"
    mem_limit: 8g
    cpus: 6
    command:
      - "zap.sh"
      - "-daemon"
      - "-host"
      - "0.0.0.0"
      - "-port"
      - "8080"
      - "-config"
      - "api.addrs.addr.name=.*"
      - "-config"
      - "api.addrs.addr.regex=true"
      - "-config"
      - "api.disablekey=true"
      - "-config"
      - "database.responseBodyMaxSize=52428800"
      - "-config"
      - "spider.maxDepth=20"
      - "-config"
      - "spider.maxDuration=120"
      - "-config"
      - "spider.threadCount=10"
      - "-config"
      - "scanner.threadPerHost=10"
      - "-config"
      - "scanner.hostPerScan=10"
    networks:
      - app-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/JSON/core/view/version/" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # OWASP ZAP Authenticated Scanner - Separate instance for authenticated scans
  # Uses same image but on port 8081, dedicated to authenticated scanning
  zap-auth:
    image: ghcr.io/zaproxy/zaproxy:stable
    container_name: zap-auth-scanner
    restart: unless-stopped
    ports:
      - "8081:8080"
    mem_limit: 8g
    cpus: 6
    command:
      - "zap.sh"
      - "-daemon"
      - "-host"
      - "0.0.0.0"
      - "-port"
      - "8080"
      - "-config"
      - "api.addrs.addr.name=.*"
      - "-config"
      - "api.addrs.addr.regex=true"
      - "-config"
      - "api.disablekey=true"
      - "-config"
      - "database.responseBodyMaxSize=52428800"
      - "-config"
      - "spider.maxDepth=20"
      - "-config"
      - "spider.maxDuration=120"
      - "-config"
      - "spider.threadCount=10"
      - "-config"
      - "scanner.threadPerHost=10"
      - "-config"
      - "scanner.hostPerScan=10"
    networks:
      - app-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/JSON/core/view/version/" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # WebCheck Scanner - Web security analysis tools
  webcheck:
    build: ./new
    container_name: ssdt-webcheck
    restart: always
    env_file:
      - ./backend/.env
    environment:
      - CHROME_PATH=/usr/bin/chromium
      - PORT=3002
      - WC_SERVER=true
    ports:
      - "3002:3002"
    networks:
      - app-network

networks:
  app-network:
    driver: bridge
